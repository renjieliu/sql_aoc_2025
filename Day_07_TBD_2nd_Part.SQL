drop table if exists #input 

-- select s_id = 1	, s = '.......S.......' into #input
-- union all select s_id = 2	, s = '...............'
-- union all select s_id = 3	, s = '.......^.......'
-- union all select s_id = 4	, s = '...............'
-- union all select s_id = 5	, s = '......^.^......'
-- union all select s_id = 6	, s = '...............'
-- union all select s_id = 7	, s = '.....^.^.^.....'
-- union all select s_id = 8	, s = '...............'
-- union all select s_id = 9	, s = '....^.^...^....'
-- union all select s_id = 10	, s = '...............'
-- union all select s_id = 11	, s = '...^.^...^.^...'
-- union all select s_id = 12	, s = '...............'
-- union all select s_id = 13	, s = '..^...^.....^..'
-- union all select s_id = 14	, s = '...............'
-- union all select s_id = 15	, s = '.^.^.^.^.^...^.'
-- union all select s_id = 16	, s = '...............'


select s_id = 1, s = '......................................................................S......................................................................'
into #input 
union all select s_id = 2, s = '.............................................................................................................................................'
union all select s_id = 3, s = '......................................................................^......................................................................'
union all select s_id = 4, s = '.............................................................................................................................................'
union all select s_id = 5, s = '.....................................................................^.^.....................................................................'
union all select s_id = 6, s = '.............................................................................................................................................'
union all select s_id = 7, s = '....................................................................^...^....................................................................'
union all select s_id = 8, s = '.............................................................................................................................................'
union all select s_id = 9, s = '...................................................................^.^.^.^...................................................................'
union all select s_id = 10, s = '.............................................................................................................................................'
union all select s_id = 11, s = '..................................................................^.^.....^..................................................................'
union all select s_id = 12, s = '.............................................................................................................................................'
union all select s_id = 13, s = '.................................................................^.^.^.^...^.................................................................'
union all select s_id = 14, s = '.............................................................................................................................................'
union all select s_id = 15, s = '................................................................^.^.^...^...^................................................................'
union all select s_id = 16, s = '.............................................................................................................................................'
union all select s_id = 17, s = '...............................................................^.^.^.^...^.^.^...............................................................'
union all select s_id = 18, s = '.............................................................................................................................................'
union all select s_id = 19, s = '..............................................................^.^.^...^.^.^.^.^..............................................................'
union all select s_id = 20, s = '.............................................................................................................................................'
union all select s_id = 21, s = '.............................................................^.^.^...^...^...^.^.............................................................'
union all select s_id = 22, s = '.............................................................................................................................................'
union all select s_id = 23, s = '............................................................^...^.^.^.^.^.^.....^............................................................'
union all select s_id = 24, s = '.............................................................................................................................................'
union all select s_id = 25, s = '...........................................................^.......^...^.^.^...^.^...........................................................'
union all select s_id = 26, s = '.............................................................................................................................................'
union all select s_id = 27, s = '..........................................................^.^.^.^.......^.^.^.^.^.^..........................................................'
union all select s_id = 28, s = '.............................................................................................................................................'
union all select s_id = 29, s = '.........................................................^.^.^.^.^.^.........^.^.^.^.........................................................'
union all select s_id = 30, s = '.............................................................................................................................................'
union all select s_id = 31, s = '........................................................^.^.^.^.^...^.^.^.^.^.^.^.^.^........................................................'
union all select s_id = 32, s = '.............................................................................................................................................'
union all select s_id = 33, s = '.......................................................^.^.^.....^...^.....^.........^.......................................................'
union all select s_id = 34, s = '.............................................................................................................................................'
union all select s_id = 35, s = '......................................................^.^.^.^.^...^...^.^...^.^.^...^.^......................................................'
union all select s_id = 36, s = '.............................................................................................................................................'
union all select s_id = 37, s = '.....................................................^...^.^.^.^.^.^...^...^...^.^.^.^.^.....................................................'
union all select s_id = 38, s = '.............................................................................................................................................'
union all select s_id = 39, s = '....................................................^.^...^.^...^.^.^.^.^.^.....^.^.^.^.^....................................................'
union all select s_id = 40, s = '.............................................................................................................................................'
union all select s_id = 41, s = '...................................................^.^...^.^...^...^.^.....^.....^...^.^.^...................................................'
union all select s_id = 42, s = '.............................................................................................................................................'
union all select s_id = 43, s = '..................................................^.^.....^...^.^...^.^.^.^.^.^.^.^.^...^.^..................................................'
union all select s_id = 44, s = '.............................................................................................................................................'
union all select s_id = 45, s = '.................................................^...^.^...^...^.^.....^.....^.........^.^.^.................................................'
union all select s_id = 46, s = '.............................................................................................................................................'
union all select s_id = 47, s = '................................................^.^.^...^.^.^.^.^.......^...^.^.^.^.^.^...^.^................................................'
union all select s_id = 48, s = '.............................................................................................................................................'
union all select s_id = 49, s = '...............................................^.........^.^.^.^.........^...^.^.^...^...^.^.^...............................................'
union all select s_id = 50, s = '.............................................................................................................................................'
union all select s_id = 51, s = '..............................................^...^.^.^.^...^.^.^.^...^.^.^...^.....^.....^.^.^..............................................'
union all select s_id = 52, s = '.............................................................................................................................................'
union all select s_id = 53, s = '.............................................^.....^.^.......^.^...^.^.^.^.......^.^.^.^...^...^.............................................'
union all select s_id = 54, s = '.............................................................................................................................................'
union all select s_id = 55, s = '............................................^...^...^.^.^.^.^...^.^.^.^...........^.^...^...^.^.^............................................'
union all select s_id = 56, s = '.............................................................................................................................................'
union all select s_id = 57, s = '...........................................^.^.^.^...^...^...^.^.^.....^.^.^.^.....^...^.^.^.^.^.^...........................................'
union all select s_id = 58, s = '.............................................................................................................................................'
union all select s_id = 59, s = '..........................................^...^...^.^.^.....^.^...^.^.^.^.^.^.......^.^.^...^.^...^..........................................'
union all select s_id = 60, s = '.............................................................................................................................................'
union all select s_id = 61, s = '.........................................^...^.^...^.^.....^.^.^.^.^.^.^.^...^.^.^.^.^.^.^...^.....^.........................................'
union all select s_id = 62, s = '.............................................................................................................................................'
union all select s_id = 63, s = '........................................^.^...^.^.^.^.^.^.^.^.......^...^.^.^.^.......^.^.^.^.^...^.^........................................'
union all select s_id = 64, s = '.............................................................................................................................................'
union all select s_id = 65, s = '.......................................^.^...^.^.^.^.^.^.^.^.^.^...^.^.....^...^...^...^.^.^.^.^.^...^.......................................'
union all select s_id = 66, s = '.............................................................................................................................................'
union all select s_id = 67, s = '......................................^.^.^...^.^.^.^.^.^...........^.^.^.^.^.^...^.^.....^.^.^.^.^.^.^......................................'
union all select s_id = 68, s = '.............................................................................................................................................'
union all select s_id = 69, s = '.....................................^.^.^.......^.^.^.......^...^.....^.^.^...^.^.^...^.^.^...^.^.^...^.....................................'
union all select s_id = 70, s = '.............................................................................................................................................'
union all select s_id = 71, s = '....................................^.^...^.^.....^.^.^...^.^.^.^.^.....^.......^.^.^...^...........^.^.^....................................'
union all select s_id = 72, s = '.............................................................................................................................................'
union all select s_id = 73, s = '...................................^.^.^...^.^.^.^...^...^.......^.^.^.^.^...^.^.^.^.^.^.^...^.^.....^...^...................................'
union all select s_id = 74, s = '.............................................................................................................................................'
union all select s_id = 75, s = '..................................^.^.....^.........^...^.^.^.^.......^.^.^...^.....^.........^.^.........^..................................'
union all select s_id = 76, s = '.............................................................................................................................................'
union all select s_id = 77, s = '.................................^.^.^.^.^.^.^.^.^...^.^...^.^.......^.^.^...^.......^.^.....^...^.^.^.....^.................................'
union all select s_id = 78, s = '.............................................................................................................................................'
union all select s_id = 79, s = '................................^.^...^...^.^.^.^...^.^.......^.^.^.^.^.^.^.^...^.^.^.....^.^.....^...^.....^................................'
union all select s_id = 80, s = '.............................................................................................................................................'
union all select s_id = 81, s = '...............................^...^.^.^.^...^.^.^.^.^...^.^...^.^.^.....^.^.^.^.^.^.^...^.......^.^.^...^.^.^...............................'
union all select s_id = 82, s = '.............................................................................................................................................'
union all select s_id = 83, s = '..............................^...^.^...^.^.^.^.^.^.^.^.......^.^.^.^.^.^...^.........^.^.....^.^.^.^...^.^...^..............................'
union all select s_id = 84, s = '.............................................................................................................................................'
union all select s_id = 85, s = '.............................^...^.^.^...^.^...^.^.^...^.^...^...^.^.^.^.......^.^...^.^...^...^.^.^...^.^.^.^.^.............................'
union all select s_id = 86, s = '.............................................................................................................................................'
union all select s_id = 87, s = '............................^.........^...........^.........^.^.^...^.^.^.^.......^...^.^.^...^.^...^.^.^.^...^.^............................'
union all select s_id = 88, s = '.............................................................................................................................................'
union all select s_id = 89, s = '...........................^.....^.^.^.^.^...^...^.^.....^.^.^...^...^.^.^.^.^...^.^...^...^.^.^.^.^...^.^.^...^.^...........................'
union all select s_id = 90, s = '.............................................................................................................................................'
union all select s_id = 91, s = '..........................^.^.^.^.^...^.....^.^.....^.^.^.^.^.^.^.^...^.^.^.^.^.^.^...^.^.^.......^.......^.^.^.^.^..........................'
union all select s_id = 92, s = '.............................................................................................................................................'
union all select s_id = 93, s = '.........................^.^.^.....^.^.^.^.^.^.....^...^.^.^.^.......^.^.^.^.^.^.^.^.^...^.^...^.^.^...^.^...^.^.^.^.........................'
union all select s_id = 94, s = '.............................................................................................................................................'
union all select s_id = 95, s = '........................^.^.^.....^.^.^...^.^.^.^.^.^...^.....^.....^.....^.^.^...^...^.^.....^...^.^.^.^.^.^.^...^.^........................'
union all select s_id = 96, s = '.............................................................................................................................................'
union all select s_id = 97, s = '.......................^.^.......^.^...^.^.^.^.^...^...^.^.^.......^.^.......^...^.....^.^...^.^.^...^.^...^.^.^.^.^.^.......................'
union all select s_id = 98, s = '.............................................................................................................................................'
union all select s_id = 99, s = '......................^...^.^.^.^.^...^.^.^.....^.^...^.^...^.....^.^.^.^.^.^.^.^.......^.^.....^...^.^.^.^.^.^.^.....^......................'
union all select s_id = 100, s = '.............................................................................................................................................'
union all select s_id = 101, s = '.....................^...^.....^.^.^.^.......^.^.^.......^...........^...^.^...^.^.^.^...^.^...^.^...^.^.^.^.^...^...^.^.....................'
union all select s_id = 102, s = '.............................................................................................................................................'
union all select s_id = 103, s = '....................^.^.^...^.^.....^...^...^.^.^.^.^.^.^.^.^.^.^.^...^.^...^.^.^.^.^...^.^.^...^.^...^.^.....^...^.^.^.^....................'
union all select s_id = 104, s = '.............................................................................................................................................'
union all select s_id = 105, s = '...................^.....^...^.^.^.^...^.......^.^...^.^.^.^...^.^...^.^.^...^.^.^...^.^.^...^.....^.^.^.^.^.^.^.^.^.^.^.^...................'
union all select s_id = 106, s = '.............................................................................................................................................'
union all select s_id = 107, s = '..................^.^.^.^.^...^.^.^.^...^.^.^.^.^...^.^.^.^...^...^...^.^.......^.^.^.^.....^.^...^.^.^...^...^.^.....^.^.^..................'
union all select s_id = 108, s = '.............................................................................................................................................'
union all select s_id = 109, s = '.................^.^.^.^.^...^.^.......^.^.^...^.^...^...^...^.^.^.^...^.^...^.^.^.^.^.^.^...^.^.^.^.^.^...^...^.^...^...^.^.................'
union all select s_id = 110, s = '.............................................................................................................................................'
union all select s_id = 111, s = '................^.^...^...........^.^.^.......^.^...^.^.^.......^...^.^.^...^...^.^...^...^.^.^.^.^.^.^.....^.^.^.^.^...^.^.^................'
union all select s_id = 112, s = '.............................................................................................................................................'
union all select s_id = 113, s = '...............^.^.....^.^...^.^...^...^.^.^.^.^.^.^.^.^...^.^...^...^.^.^.^.^.^.^.^.^.^.^.^.^.^...^.^...^.........^.^.^.^.^.^...............'
union all select s_id = 114, s = '.............................................................................................................................................'
union all select s_id = 115, s = '..............^...^...^.^.^.^.^.^...^.^.^...^.^.....^.^.^.......^...^.^...^.^.^...^...^.^.^.^.^...^.^...^.^...........^.....^.^..............'
union all select s_id = 116, s = '.............................................................................................................................................'
union all select s_id = 117, s = '.............^.......^...^...^.^...^.^.^.....^.......^.^.^...^.^.^.^.^.^.^.^.......^...^.^.^.^.^.^.^.....^.^.......^.....^.^.^.^.............'
union all select s_id = 118, s = '.............................................................................................................................................'
union all select s_id = 119, s = '............^...^.^.^.^.^.....^.^.^.^.^.^.^.^.^.^.^...^.^.^.^...^.^...^.^.....^.^...^.......^...^...........^.^.^...^.^...^.^.^.^............'
union all select s_id = 120, s = '.............................................................................................................................................'
union all select s_id = 121, s = '...........^.....^.^.^...^.^.^.^.^.....^...^...^...^.^.^.......^.....^.^.^.^.....^.^.^.^.^.^.^.^...^.^.^.^.^.^.^...^.^...^.^...^.^...........'
union all select s_id = 122, s = '.............................................................................................................................................'
union all select s_id = 123, s = '..........^.^.^.^.^.^.^...^...^...^.....^.^.........^...^.^.....^...^...^.^.....^.^.^.^.^...^.^.^...^.^.^...^.....^.....^.^...^.^.^..........'
union all select s_id = 124, s = '.............................................................................................................................................'
union all select s_id = 125, s = '.........^.^...^.^...^...^.....^...^.^.........^...^.^.^.....^.^...........^.^...^.^.^...^.^.......^.^.^.^.^...^.^.^.^...^.^.^.....^.........'
union all select s_id = 126, s = '.............................................................................................................................................'
union all select s_id = 127, s = '........^.^.^.^.^...^...^.....^...^.^.^.^.........^...^.^.^.....^...^.^...^.^.^.....^.^.^.^.^.....^...^.^...^.^.^.^...^.^...^.^.^.^.^........'
union all select s_id = 128, s = '.............................................................................................................................................'
union all select s_id = 129, s = '.......^...^.^.^...^.......^.....^.^...^.^.^.^.^.^.^.^...^...^.^.^.^.^.^.^.^.^...^.^.^.^.^.^.^.^.^...^.^.^.^.^.^...^.^.^.^.^.....^.^.^.......'
union all select s_id = 130, s = '.............................................................................................................................................'
union all select s_id = 131, s = '......^...^.^.^...^...^.^...^.^.....^.^.....^.^.^.^...^.^...^...^.....^.^...^.^.^.^.^.^.^...^.^.^.^.^...^.^.^.^.^.^.^...^.^.^...^.....^......'
union all select s_id = 132, s = '.............................................................................................................................................'
union all select s_id = 133, s = '.....^.....^...^.^.^...^...^.^.^.^.^...^.^.^.^.^...^.^...^.^.^.....^...^.^.^.^.....^...^.........^.....^.^...^.^.^.....^.^.^.^.^.^.....^.....'
union all select s_id = 134, s = '.............................................................................................................................................'
union all select s_id = 135, s = '....^.....^.^.^.......^.^.....^.^.^.^.....^.^.^.^...^.^.^.^.^.^.....^.^...^...^.^.^.^.^.^.........^.^.^.^.^...^.^.^...^.^.^...^.^...^.^.^....'
union all select s_id = 136, s = '.............................................................................................................................................'
union all select s_id = 137, s = '...^.........^.^.^...^...^.^.^.^.....^.^...^.^.....^.^.^...^.^.^.....^.^.^...^.^.^.^.^.^.^.^.....^.^.^.^...^.....^.^.^.^.^...^.......^.^.^...'
union all select s_id = 138, s = '.............................................................................................................................................'
union all select s_id = 139, s = '..^.^...^.^...^.^.^.^.....^.^.....^...^.^.....^.^.^.^.^...^.....^.^.^...^.^.........^.^.^.........^.........^.^.^.^.^.^...^.^.^.^.^.^...^.^..'
union all select s_id = 140, s = '.............................................................................................................................................'
union all select s_id = 141, s = '.^.....^...^.^.^...^.^.^.^.^.^.^.^.^.^...^.^.^.^.^.^.^.^...^.^...^.^.^.^.^...^.^.....^.^...^.^.^.^.^...^...^...^...^.^.^...^.........^.^.^.^.'
union all select s_id = 142, s = '.............................................................................................................................................'



-- select * from #input

drop table if exists #base 

; with cte as
(
    select r = s_id,  c = 1, ch = left(s, 1), rem = SUBSTRING(s, 2 , len(s)) from #input 
    union all 
    select r, c+1, left(rem, 1), SUBSTRING(rem, 2, len(rem))  from cte  
    where len(rem) > 0    
)
select r, c, ch into #base from cte 
order by r, c
option (maxrecursion 0)
 


-- 20251207_090511 
--- Stop here  - the issue is to look back the previous line, and update before continue
-- Right now, I can only think of using a custom function for string manipulation

drop table if exists #base_2

; with line_len as (
select r_width = count(*)
from #base 
where r = 1
)
, get_id as 
(
select id = (r-1) * r_width + c, ch = iif(ch = 'S', '|', ch) from #base, line_len
)
, concat as (
select all_input = STRING_AGG(cast(ch as varchar(max)), ';') within group (order by id) + ';'  from get_id
)
, base as ( 
select id, ch, all_input, r_width  from get_id, CONCAT, line_len
)
select * into #base_2 from base
OPTION(maxrecursion 0)



drop table if exists #res_1


; with cte as 
(select 
    id
    , calc_all_input = cast(all_input as varchar(max))
    , split = 0 
    from #base_2 
    where id = 1 

    union all 

    select
     b.id
    , calc_all_input = cast( case when b.ch = '^' and prev_r.prev_r_ch = '|' -- previous r
                                  then stuff(
                                            stuff( calc_all_input, (b.id-1)*2-1, cnt_character , '|') -- previous slot needs to be changed 
                                            , b.id* 2 + 1  -- next slot needs to be changed as well 
                                            , cnt_character
                                            , '|'
                                            )
                                  when b.ch = '^' or SUBSTRING(calc_all_input, b.id * 2 -1, 1) = '|' then calc_all_input -- current one is ^ current one is already calculated 
                                  else stuff(calc_all_input, b.id * 2-1, cnt_character, prev_r.prev_r_ch)  -- just use the previous row character
                             end
                        as varchar(max))
     , split + case when ch = '^' and prev_r.prev_r_ch = '|' then 1 else 0 end
    from cte c 
    inner join #base_2 b on b.id = c.id + 1 
    cross apply ( select cnt_character = iif( (b.id -1 ) / r_width > 0,  1 ,  0 ) ) take_out -- to determine if stuff  to take out 0 or 1 character. for the first line, take out 0
    cross apply ( select prev_r_ch = SUBSTRING(calc_all_input, b.id * 2 - 1 - ( r_width*2) , 1) ) prev_r
)
select * into #res_1 from cte 
option (maxrecursion 0 )


-- 
select ans1 = max(split) from #res_1









